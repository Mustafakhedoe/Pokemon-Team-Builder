<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pokémon Team Builder — Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root { --accent:#e60012; } body{background:#f8f9fa;}
    .navbar-custom{background:var(--accent);} .navbar-custom .navbar-brand{color:#fff;}
    .table-fixed tbody{display:block;max-height:60vh;overflow:auto;}
    .table-fixed thead,.table-fixed tbody tr{display:table;width:100%;table-layout:fixed;}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-custom shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="index.html">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" width="24" alt=""/> Admin
      </a>
      <a href="index.html" class="btn btn-outline-light btn-sm ms-auto">Terug</a>
    </div>
  </nav>

  <main class="container py-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5>Teams beheren</h5>
          <div class="d-flex gap-2">
            <button id="repair" class="btn btn-sm btn-outline-warning">Repair claims</button>
            <button id="refresh" class="btn btn-sm btn-secondary">Vernieuwen</button>
            <button id="logout" class="btn btn-sm btn-outline-danger">Admin uitloggen</button>
          </div>
        </div>
        <table class="table table-fixed mt-3">
          <thead>
            <tr>
              <th style="width:20%">Gebruiker</th>
              <th style="width:15%">Picks</th>
              <th style="width:35%">Team</th>
              <th style="width:15%">Opgeslagen</th>
              <th style="width:15%">Acties</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    const CLAIMS_KEY='ptb_claims', TEAMS_KEY='ptb_teams', ADMIN_KEY='ptb_admin', ADMIN_CODE='SHAMUS117', MAX_TEAM=10;
    const normalize = s => (s ?? '').toString().trim().toLowerCase();
    const art = id => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;

    // Vereis code
    (function ensureLogin(){
      if(localStorage.getItem(ADMIN_KEY) !== '1'){
        const code = prompt('Admin code:');
        if(code !== ADMIN_CODE){ alert('Onjuiste code.'); location.href='index.html'; }
        else localStorage.setItem(ADMIN_KEY,'1');
      }
    })();

    const load = () => ({
      claims: JSON.parse(localStorage.getItem(CLAIMS_KEY) || '{}'),
      teams:  JSON.parse(localStorage.getItem(TEAMS_KEY) || '[]')
    });

    function render(){
      const state = load();
      const tb = document.getElementById('tbody'); tb.innerHTML='';
      if(!state.teams.length){
        tb.innerHTML = '<tr><td colspan="5" class="text-muted">Nog geen teams opgeslagen.</td></tr>';
        return;
      }
      const sorted = [...state.teams].sort((a,b)=>a.user.localeCompare(b.user));
      sorted.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="width:20%">${t.user}</td>
          <td style="width:15%">${t.team.length}</td>
          <td style="width:35%"></td>
          <td style="width:15%">${new Date(t.savedAt||Date.now()).toLocaleString()}</td>
          <td style="width:15%" class="text-end"></td>`;
        const teamTd = tr.children[2];
        t.team.forEach(id=>{ const img=document.createElement('img'); img.src=art(id); img.width=28; img.height=28; img.className='me-1'; teamTd.appendChild(img); });
        const actTd = tr.children[4];
        const edit=document.createElement('button'); edit.textContent='Bewerken'; edit.className='btn btn-sm btn-outline-primary me-2';
        const del=document.createElement('button'); del.textContent='Verwijderen'; del.className='btn btn-sm btn-outline-danger';
        actTd.append(edit,del);
        edit.onclick=()=>editTeam(t.user);
        del.onclick=()=>delTeam(t.user);
        tb.appendChild(tr);
      });
    }

    function delTeam(user){
      const state = load();
      if(!confirm(`Team van "${user}" verwijderen?`)) return;

      const teams = state.teams.filter(t => normalize(t.user) !== normalize(user));
      const claims = {...state.claims};
      Object.keys(claims).forEach(id => { if(normalize(claims[id]) === normalize(user)) delete claims[id]; });

      localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
      localStorage.setItem(CLAIMS_KEY, JSON.stringify(claims));
      localStorage.setItem('ptb_ping', String(Date.now()));
      render();
    }

    function editTeam(user){
      const state = load();
      const t = state.teams.find(x => normalize(x.user) === normalize(user));
      if(!t) return;

      const raw = prompt('Nieuwe team IDs (komma-gescheiden, max 10):', t.team.join(','));
      if(raw === null) return;
      const ids = raw.split(',').map(s=>parseInt(s.trim(),10)).filter(n=>Number.isInteger(n) && n>0);
      if(ids.length > MAX_TEAM){ alert('Max 10.'); return; }

      for(const id of ids){
        const by = state.claims[id];
        if(by && normalize(by) !== normalize(user)){ alert(`#${id} is al geclaimd door ${by}`); return; }
      }

      const claims = {...state.claims};
      Object.keys(claims).forEach(id => { if(normalize(claims[id]) === normalize(user)) delete claims[id]; });
      ids.forEach(id => claims[id] = user);

      const teams = [...state.teams];
      const idx = teams.findIndex(x => normalize(x.user) === normalize(user));
      if(idx >= 0) teams[idx] = { user, team: ids, savedAt: Date.now() };

      localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
      localStorage.setItem(CLAIMS_KEY, JSON.stringify(claims));
      localStorage.setItem('ptb_ping', String(Date.now()));
      render();
    }

    // Repair: verwijder claims met lege/ongeldige eigenaar
    function repairClaims(){
      const state = load();
      const validUsers = new Set(state.teams.map(t => normalize(t.user)));
      const claims = {...state.claims};
      let removed = 0;
      Object.keys(claims).forEach(id => {
        const owner = normalize(claims[id]);
        if(!owner || !validUsers.has(owner)){ delete claims[id]; removed++; }
      });
      if(removed){
        localStorage.setItem(CLAIMS_KEY, JSON.stringify(claims));
        localStorage.setItem('ptb_ping', String(Date.now()));
        alert(`Repair klaar: ${removed} oude claims verwijderd.`);
        render();
      } else {
        alert('Geen reparatie nodig');
      }
    }

    document.getElementById('refresh').onclick = render;
    document.getElementById('logout').onclick  = ()=>{ localStorage.removeItem(ADMIN_KEY); location.href='index.html'; };
    document.getElementById('repair').onclick  = repairClaims;

    render();
  </script>
</body>
</html>
