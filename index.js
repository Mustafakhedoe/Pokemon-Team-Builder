// index.js
import { auth } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { createTeam, listMyTeams, ensureSignedIn } from "./api.js";

// --- helpers/state ---
const USERS_KEY = 'ptb_users';
const CURRENT_USER_KEY = 'ptb_current_user';
const CLAIMS_KEY = 'ptb_claims';
const TEAMS_KEY = 'ptb_teams';
const ADMIN_KEY = 'ptb_admin';
const ADMIN_CODE = 'SHAMUS117';
const MAX_TEAM = 10;

const art = id => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;

const BASE_GEN1 = Array.from({ length: 151 }, (_, i) => i + 1);
const EXTRA_INSERTS = [
    { id: 172, position: 'before', ref: 25 },   // Pichu voor Pikachu
    { id: 169, position: 'after', ref: 42 },    // Crobat na Golbat
    { id: 174, position: 'before', ref: 39 },   // Igglybuff voor Jigglypuff
    { id: 182, position: 'after', ref: 45 },    // Bellossom na Vileplume
    { id: 186, position: 'after', ref: 62 },    // Politoed na Poliwrath
    { id: 199, position: 'after', ref: 80 },    // Slowking na Slowbro
    { id: 462, position: 'after', ref: 82 },    // Magnezone na Magneton
    { id: 979, position: 'after', ref: 57 },    // Annihilape na Primeape
    { id: 208, position: 'after', ref: 95 },    // Steelix na Onix
    { id: 173, position: 'before', ref: 35 },   // Cleffa voor Clefairy
    { id: 236, position: 'before', ref: 106 },  // Tyrogue voor Hitmonlee
    { id: 237, position: 'after', ref: 107 },   // Hitmontop na Hitmonchan
    { id: 463, position: 'after', ref: 108 },   // Lickilicky na Lickitung
    { id: 440, position: 'before', ref: 113 },  // Happiny voor Chansey
    { id: 242, position: 'after', ref: 113 },   // Blissey na Chansey
    { id: 465, position: 'after', ref: 114 },   // Tangrowth na Tangela
    { id: 230, position: 'after', ref: 117 },   // Kingdra na Seadra
    { id: 212, position: 'after', ref: 123 },   // Scizor na Scyther
    { id: 900, position: 'after', ref: 212 },   // Kleavor na Scizor
    { id: 238, position: 'before', ref: 124 },  // Smoochum voor Jynx
    { id: 239, position: 'before', ref: 125 },  // Elekid voor Electabuzz
    { id: 466, position: 'after', ref: 125 },   // Electivire na Electabuzz
    { id: 240, position: 'before', ref: 126 },  // Magby voor Magmar
    { id: 467, position: 'after', ref: 126 },   // Magmortar na Magmar
    { id: 196, position: 'after', ref: 136 },   // Espeon na Flareon
    { id: 197, position: 'after', ref: 196 },   // Umbreon na Espeon
    { id: 470, position: 'after', ref: 197 },   // Leafeon na Umbreon
    { id: 471, position: 'after', ref: 470 },   // Glaceon na Leafeon
    { id: 700, position: 'after', ref: 471 },   // Sylveon na Glaceon
    { id: 233, position: 'after', ref: 137 },   // Porygon2 na Porygon
    { id: 474, position: 'after', ref: 233 },   // Porygon-Z na Porygon2
];
const GEN1 = (() => {
    const order = [...BASE_GEN1];
    EXTRA_INSERTS.forEach(({ id, position, ref }) => {
        const idx = order.indexOf(ref);
        if (idx === -1) return;
        order.splice(position === 'before' ? idx : idx + 1, 0, id);
    });
    return order;
})();

const normalize = s => (s ?? '').toString().trim().toLowerCase();
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const state = {
    users: JSON.parse(localStorage.getItem(USERS_KEY) || '[]'),
    currentUser: localStorage.getItem(CURRENT_USER_KEY) || '',
    claims: JSON.parse(localStorage.getItem(CLAIMS_KEY) || '{}'),
    teams: JSON.parse(localStorage.getItem(TEAMS_KEY) || '[]'),
};

// --- functions ---
function registerName(name) {
    const clean = (name || '').trim();
    if (!clean) return false;
    if (!state.users.some(u => normalize(u) === normalize(clean))) {
        state.users.push(clean); save(USERS_KEY, state.users);
    }
    state.currentUser = clean;
    localStorage.setItem(CURRENT_USER_KEY, clean);
    return true;
}
function refreshFromStorage() {
    state.claims = JSON.parse(localStorage.getItem(CLAIMS_KEY) || '{}');
    state.teams  = JSON.parse(localStorage.getItem(TEAMS_KEY) || '[]');
}
function getMy() {
    return Object.keys(state.claims)
        .filter(id => normalize(state.claims[id]) === normalize(state.currentUser))
        .map(Number);
}

// --- UI ---
function renderGrid() {
    const grid = document.getElementById('grid'); grid.innerHTML = '';
    GEN1.forEach(id => {
        const claimedBy = state.claims[id];
        const isMine = claimedBy && normalize(claimedBy) === normalize(state.currentUser);
        const isTaken = claimedBy && !isMine;

        const col = document.createElement('div'); col.className = 'col-6 col-sm-4 col-md-3 mb-3';
        const card = document.createElement('div'); card.className = 'poke-card text-center p-2 ' + (isTaken ? 'taken' : (isMine ? 'mine' : 'available'));

        const img = document.createElement('img'); img.src = art(id); img.alt = `#${String(id).padStart(3,'0')}`;
        const txt = document.createElement('div'); txt.textContent = `#${String(id).padStart(3,'0')}`;

        card.append(img, txt); col.appendChild(card); grid.appendChild(col);

        if (!isTaken) {
            card.addEventListener('click', () => {
                if (!state.currentUser) {
                    new bootstrap.Modal(document.getElementById('startModal')).show();
                    return;
                }
                toggle(id);
            });
        }
    });
    renderDash();
}

function toggle(id) {
    const claim = state.claims[id];
    if (claim && normalize(claim) !== normalize(state.currentUser)) return;
    if (claim) delete state.claims[id];
    else {
        if (getMy().length >= MAX_TEAM) { alert('Max 10 in je team'); return; }
        state.claims[id] = state.currentUser;
    }
    save(CLAIMS_KEY, state.claims);
    localStorage.setItem('ptb_ping', String(Date.now()));
    renderGrid();
}

function renderDash() {
    const mine = getMy();
    document.getElementById('selectedCount').textContent = mine.length;
    document.getElementById('currentUserText').textContent = state.currentUser ? `Ingelogd als: ${state.currentUser}` : 'Niet ingelogd.';
    const list = document.getElementById('selectedList'); list.innerHTML = '';
    mine.forEach(id => { const img = document.createElement('img'); img.src = art(id); img.width = 48; img.height = 48; img.className = 'me-1'; list.appendChild(img); });
    renderSaved();
}

function renderSaved() {
    const root = document.getElementById('savedTeams'); root.innerHTML = '';
    const sorted = [...state.teams].sort((a, b) => (b.savedAt || 0) - (a.savedAt || 0));
    sorted.forEach(t => {
        const row = document.createElement('div'); row.className = 'border rounded p-2';
        const title = document.createElement('div'); title.className = 'fw-semibold mb-1'; title.textContent = t.user; row.appendChild(title);
        (t.team || []).forEach(id => { const img = document.createElement('img'); img.src = art(id); img.width = 36; img.height = 36; img.className = 'me-1'; row.appendChild(img); });
        root.appendChild(row);
    });
}

// --- Events ---
document.getElementById('saveTeam').onclick = async () => {
    if (!state.currentUser) {
        new bootstrap.Modal(document.getElementById('startModal')).show();
        return;
    }
    const mine = getMy();
    if (!mine.length) return alert('Geen PokÃ©mon gekozen');

    try {
        await ensureSignedIn();
        await createTeam(`${state.currentUser} team`, mine.map(id => ({ pokemonId: id })));
        alert('Team opgeslagen!');

        const teams = await listMyTeams();
        state.teams = teams.map(t => ({
            user: state.currentUser,
            team: (t.members || []).map(m => m.pokemonId),
            savedAt: t.createdAt?.toMillis?.() || Date.now()
        }));
        renderSaved();
    } catch (e) {
        console.error('saveTeam error', e);
        alert('Opslaan mislukt');
    }
};

document.getElementById('clearMine').onclick = () => {
    Object.keys(state.claims).forEach(id => { if (normalize(state.claims[id]) === normalize(state.currentUser)) delete state.claims[id]; });
    save(CLAIMS_KEY, state.claims);
    localStorage.setItem('ptb_ping', String(Date.now()));
    renderGrid();
};

document.getElementById('nameForm').onsubmit = e => {
    e.preventDefault();
    if (registerName(document.getElementById('username').value)) {
        document.body.classList.remove('lock');
        renderGrid(); renderSaved();
    }
};
document.getElementById('startForm').onsubmit = e => {
    e.preventDefault();
    if (registerName(document.getElementById('startName').value)) {
        document.body.classList.remove('lock');
        bootstrap.Modal.getInstance(document.getElementById('startModal')).hide();
        renderGrid(); renderSaved();
    }
};

document.getElementById('gotoAdmin').addEventListener('click', e => {
    e.preventDefault();
    const code = prompt('Admin code:');
    if (code && code.trim() === ADMIN_CODE) { localStorage.setItem(ADMIN_KEY, '1'); window.location.href = 'admin.html'; }
    else alert('Onjuiste code.');
});

window.addEventListener('storage', e => {
    if ([CLAIMS_KEY, TEAMS_KEY, 'ptb_ping'].includes(e.key)) {
        refreshFromStorage();
        renderGrid();
    }
});

// --- Firestore sync ---
onAuthStateChanged(auth, async (user) => {
    if (!user) return; // nog niet ingelogd
    console.log("Ingelogd als UID:", user.uid);

    try {
        const teams = await listMyTeams();
        state.teams = teams.map(t => ({
            user: state.currentUser || 'Ik',
            team: (t.members || []).map(m => m.pokemonId),
            savedAt: t.createdAt?.toMillis?.() || Date.now()
        }));
        renderSaved();
    } catch (e) {
        console.error('Teams laden mislukt:', e);
    }
});

// --- Start ---
if (!state.currentUser) {
    document.body.classList.add('lock');
    new bootstrap.Modal(document.getElementById('startModal')).show();
}
document.addEventListener('DOMContentLoaded', () => {
    renderGrid(); renderSaved();
});

